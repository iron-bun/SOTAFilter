<html>
<head>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
     integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
     crossorigin=""></script>
 <style>
    #map {
        height: 90%;
    }
    #faq_button { float: right; }
    #faq {
        position: absolute;
        top: 50px;
        right: 100px;
        z-index: 1000;
        display: none;
        padding: 5px;
        width: 400px;
        max-height:80%;
        overflow:auto;
        border:1px solid black;
        background:white;
    }
 </style>
 <script>

    let global_map;
    let summits_layer = L.layerGroup();
    let summits = {}
    let stops_layer = L.layerGroup();

    var greenIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    function init_map() {
        global_map = L.map('map', {center: [55.910945, -3.201114], zoom:10});

        var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(global_map);

        global_summits = L.layerGroup().addTo(global_map);
        global_stops = L.layerGroup().addTo(global_map);

        var client = new XMLHttpRequest();
        client.onreadystatechange = () => { if (client.readyState === 4 && client.status === 200) load_regions(client.responseText); };
        client.open('GET', './regions.json');
        client.send();
    }

    function load_regions(contents) {

        var results = JSON.parse(contents);

        var region_selector = document.getElementById('region_selector');
        region_selector.disabled = false;

        for (var i=0; i<results.length; i++) {
            var opt = document.createElement('option');

            opt.value = results[i].region;
            opt.innerHTML = results[i].description;
            region_selector.appendChild(opt);
        }
    }

    function get_features() {

        var region_selector = document.getElementById('region_selector');
        if (region_selector.value == 'null') { return; }

        var client = new XMLHttpRequest();

        client.onreadystatechange = () => { if (client.readyState === 4 && client.status === 200) load_features(client.responseText); };
        client.open('GET', `./${region_selector.value}.json`);
        client.send();
    }

    function load_features(contents) {

        global_summits.eachLayer((layer) => {layer.remove();});
        global_stops.eachLayer((layer) => {layer.remove();});
        summits = {}

        var features = JSON.parse(contents);

        var min_lat = null, max_lat = null, min_lon = null, max_lon = null;

        for (var i=0; i<features.length; i++) {

            var lat = features[i].coordinates[0], lon = features[i].coordinates[1];
            if (min_lat == null || min_lat > lat) { min_lat = lat; }
            if (max_lat == null || max_lat < lat) { max_lat = lat; }
            if (min_lon == null || min_lon > lon) { min_lon = lon; }
            if (max_lon == null || max_lon < lat) { max_lon = lon; }

            var popupText = "<a href='https://sotl.as/summits/" + features[i].id + "' target='_new'>" + features[i].id + "</a></br>" + features[i].name;
            var summit = L.marker(features[i].coordinates).bindPopup(popupText);

            stops = features[i].stops;
            var tmp = [];
            for (var j=0; j<stops.length; j++) {
                popupText = stops[j].name + "</br><a href='https://www.google.com/maps/dir/?api=1&destination=" + stops[j].coordinates[0] + "," + stops[j].coordinates[1] + "&travelmode=transit' target='_new'>directions</a>";
                tmp.push(L.marker(stops[j].coordinates, {icon:greenIcon}).bindPopup(popupText));
            }

            var lg = L.layerGroup(tmp);

            summit.on('click', getClickEvent(lg));

            global_summits.addLayer(summit);
            summits[features[i].id] = summit;
            
        }

        if (min_lat != null && min_lon != null)
            global_map.fitBounds([[min_lat, min_lon], [max_lat,max_lon]]);

    }

    function getClickEvent(thisLayerGroup) {
        return (e) => {
            global_stops.eachLayer((layer) => { layer.remove(); });
            global_stops.addLayer(thisLayerGroup);
        }
    }

  function highlight_summit() {
      var id = document.getElementById("summit_ref").value.toUpperCase();
      if (id in summits) {
          summits[id].fire('click');
          global_map.setView(summits[id]._latlng, 10);
      }
  }

  function check_search(e) {
    if (e && e.keyCode == 13) {
        highlight_summit()
    }
  }

  function show_hide_faq() {
    var faq = document.getElementById("faq");
    if (!faq.style.display || faq.style.display == "none") {
        faq.style.display = "block";
    } else {
        faq.style.display = "none";
    }
  }

 </script>
</head>
<body onload="init_map()">
 Select Region: <select id="region_selector" disabled="true" onchange="get_features()">
   <option value='null'>--</option>
 </select>
 Search for summit by ref <input id="summit_ref" onKeyPress="check_search(event)"/><button onclick="highlight_summit()">Go</button>
 <div id="faq_button" onclick="show_hide_faq()">FAQ</div>
 <div id="faq">
   <h1>What are you trying to do here?</h1>
   <p>I would like to go to <a href="https://www.sota.org.uk/">SOTA</a> summits with my amateur radio gear but I don't have a car so I have to take public transport. This map shows SOTA summits within 5km of a public transport stop, which includes (depending on the data availability) bus and train stops and ferry terminals.</p>
   <h1>Why not use Google maps or something?</h1>
   <p>Itinerary services are great if you know where you want to go and it's a short walk once you get there. Looking for routes to summits often returns no results even when there are public transport stops within a reasonable hike. Scouring the map for the nearest suitable bus stop made me very thoughtful about automation. This site starts by filtering out summits that are definitely out of reach, then links you to directions to the transit stop which usually gives good results.</p>
   <h1>I found a stop that nothing seems to go to?</h1>
   <p>The existence of a bus stop does not imply the existence of a bus and there are a lot of orphaned stops in the world. You should work out and verify your travel plans using a different service. Scheduling is a hard problem and outside the scope of this site.</p>
   <h1>Why is my summit missing? I know buses go there.</h1>
   <p>I can't find the stop in the publically avaiable data. Some bus services will stop or collect on demand without an official stop in the area which is great for flexibility, but incorporating that would need a <em>lot</em> more data and processing. Some summits are going to be unfairly dropped.</p>
   <h1>Why only 5km to a transit stop? Can I change it?</h1>
   <p>5km was a figure I plucked from the air based on my own ability to hike over unfamiliar ground for an hour or two. It assumes that you won't be travelling in a straight line and also that there will be a significant amount of ascent and descent. If you can do better, that's fantastic. Wherever I draw the line will be unsuitable for some people.</p>
 </div>
 <div id="map"></div>
</body>
</html>
